[
  {
    "objectID": "sessions/api.html",
    "href": "sessions/api.html",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "",
    "text": "Pour installer toutes les d√©pendances n√©cessaires pour ce tutoriel, vous pouvez taper, en ligne de commande:"
  },
  {
    "objectID": "sessions/api.html#comprendre-le-principe-avec-un-exemple-interactif",
    "href": "sessions/api.html#comprendre-le-principe-avec-un-exemple-interactif",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "2.1 Comprendre le principe avec un exemple interactif",
    "text": "2.1 Comprendre le principe avec un exemple interactif\nLe premier mode (acc√®s par un navigateur) est principalement utilis√© lorsqu‚Äôune interface web permet √† un utilisateur de faire des choix afin de lui renvoyer des r√©sultats correspondant √† ceux-ci. Prenons √† nouveau l‚Äôexemple de l‚ÄôAPI de g√©olocalisation que nous utiliserons dans ce chapitre. Imaginons une interface web permettant √† l‚Äôutilisateur deux choix : un code postal et une adresse. Cela sera inject√© dans la requ√™te et le serveur r√©pondra avec la g√©olocalisation adapt√©e.\n\n\n\nviewof codePostal = Inputs.text({value: \"92120\", placeholder: \"92120\", label: md`**Code Postal**`})\n\n\n\n\n\n\n\n\n\n\nviewof adresse = Inputs.text({value: defaultAdresse, placeholder: defaultAdresse, label: md`**Adresse**`})\n\n\n\n\n\n\n\n\n\nmd`\n${\nawait mj`$$\\underbrace{\\text{${apiroot}}}_{\\text{API root}}/\\underbrace{\\text{search}}_{\\text{API endpoint}}/?\\underbrace{\\text{${param1}}}_{\\text{main parameter}}\\&\\underbrace{\\text{${param2}}}_{\\text{additional parameter}}$$`\n}\n`\n\n\n\n\n\n\n\nmap = {\n  const container = html`&lt;div style=\"height:300px;\"&gt;`;\n  yield container;\n  const map = L.map(container).setView([latitude, longitude], 13);\n  L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\n    attribution: \"&copy; &lt;a href=https://www.openstreetmap.org/copyright&gt;OpenStreetMap&lt;/a&gt; contributors\"\n  }).addTo(map);\n  var marker = L.marker([latitude, longitude]).addTo(map);\n  marker.bindPopup(\"&lt;b&gt;Trouv√© !&lt;/b&gt;\").openPopup();\n  return map\n}\n\n\n\n\n\n\nüîé Allons voir ce que cela donne dans l‚Äôonglet R√©seau des outils de d√©veloppement de notre navigateur (dans firefox, raccourci  CTRL+MAJ+K).\n\nhtml`\n Pour preuve que cette requ√™te est bien fonctionnelle, on peut l'ouvrir dans un navigateur : &lt;a href=\"${url}\" target=\"_blank\" title=\"Test de url dans un navigateur\"&gt;\n &lt;i class=\"fa-solid fa-magnifying-glass\"&gt;&lt;/i&gt;&lt;/i&gt;\n`\n\n\n\n\n\n\nCe qui nous donne un output au format JSON, le format de sortie d‚ÄôAPI le plus commun.\nSi on veut un beau rendu, comme la carte ci-dessus, il faudra que le navigateur retravaille cet output, ce qui se fait normalement avec Javascript, le langage de programmation embarqu√© par les navigateurs."
  },
  {
    "objectID": "sessions/api.html#comment-faire-avec-python",
    "href": "sessions/api.html#comment-faire-avec-python",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "2.2 Comment faire avec Python  ?",
    "text": "2.2 Comment faire avec Python  ?\nLe principe est le m√™me sauf que nous perdons l‚Äôaspect interactif. Il s‚Äôagira donc, avec Python, de construire l‚ÄôURL voulue et d‚Äôaller chercher via une requ√™te HTTP le r√©sultat.\nPython communique avec internet : via le package requests. Ce package suit le protocole HTTP o√π on retrouve principalement deux types de requ√™tes : GET et POST :\n\nLa requ√™te GET est utilis√©e pour r√©cup√©rer des donn√©es depuis un serveur web. C‚Äôest la m√©thode la plus simple et courante pour acc√©der aux ressources d‚Äôune page web. Nous allons commencer par d√©crire celle-ci.\nLa requ√™te POST est utilis√©e pour envoyer des donn√©es au serveur, souvent dans le but de cr√©er ou de mettre √† jour une ressource. Sur les pages web, elle sert souvent √† la soumission de formulaires qui n√©cessitent de mettre √† jour des informations sur une base (mot de passe, informations clients, etc.). Nous verrons son utilit√© plus tard, lorsque nous commencerons √† rentrer dans les requ√™tes authentifi√©es o√π il faudra soumettre des informations suppl√©mentaires √† notre requ√™te.\n\nFaisons un premier test avec Python en faisant comme si nous connaissions bien cette API.\n\nimport requests\nadresse = \"88 avenue verdier\"\nurl_ban_example = f\"https://api-adresse.data.gouv.fr/search/?q={adresse.replace(\" \", \"+\")}&postcode=92120\"\nrequests.get(url_ban_example)\n\n&lt;Response [200]&gt;\n\n\nQu‚Äôest-ce qu‚Äôon obtient ? Un code HTTP. Le code 200 correspond aux requ√™tes r√©ussies, c‚Äôest-√†-dire pour lesquelles le serveur est en mesure de r√©pondre. Si ce n‚Äôest pas le cas, pour une raison x ou y, vous aurez un code diff√©rent.\n\n\n\n\n\n\nLes codes HTTP\n\n\n\n\n\nLes codes de statut HTTP sont des r√©ponses standard envoy√©es par les serveurs web pour indiquer le r√©sultat d‚Äôune requ√™te effectu√©e par un client (comme un navigateur ou un script Python). Ils sont class√©s en diff√©rentes cat√©gories selon le premier chiffre du code :\n\n1xx : Informations\n2xx : Succ√®s\n3xx : Redirections\n4xx : Erreurs c√¥t√© client\n5xx : Erreurs c√¥t√© serveur\n\nCeux √† retenir sont : 200 (succ√®s), 400 (requ√™te mal structur√©e), 401 (authentification non r√©ussie), 403 (acc√®s interdit), 404 (ressource demand√©e n‚Äôexiste pas), 503 (le serveur n‚Äôest pas en capacit√© de r√©pondre)\n\n\n\nPour r√©cup√©rer le contenu renvoy√© par requests, il existe plusieurs m√©thodes. Quand on un JSON bien formatt√©, le plus simple est d‚Äôutiliser la m√©thode json qui transforme cela en dictionnaire :\n\nreq = requests.get(url_ban_example)\nlocalisation_insee = req.json()\nlocalisation_insee\n\n{'type': 'FeatureCollection',\n 'features': [{'type': 'Feature',\n   'geometry': {'type': 'Point', 'coordinates': [2.309144, 48.81622]},\n   'properties': {'label': '88 Avenue Verdier 92120 Montrouge',\n    'score': 0.9735636363636364,\n    'housenumber': '88',\n    'id': '92049_9625_00088',\n    'banId': '92dd3c4a-6703-423d-bf09-fc0412fb4f89',\n    'name': '88 Avenue Verdier',\n    'postcode': '92120',\n    'citycode': '92049',\n    'x': 649270.67,\n    'y': 6857572.24,\n    'city': 'Montrouge',\n    'context': '92, Hauts-de-Seine, √éle-de-France',\n    'type': 'housenumber',\n    'importance': 0.7092,\n    'street': 'Avenue Verdier',\n    '_type': 'address'}}]}\n\n\n\n\n\n\n\nEn l‚Äôoccurrence, on voit que les donn√©es sont dans un JSON imbriqu√©. Il faut donc d√©velopper un peu de code pour r√©cup√©rer les informations voulues dans celui-ci:\n\nlocalisation_insee.get('features')[0].get('properties')\n\n\n\n\n\n\nC‚Äôest l√† l‚Äôinconv√©nient principal de l‚Äôusage des API : le travail ex post sur les donn√©es renvoy√©es est parfois important. Le code n√©cessaire est propre √† chaque API puisque l‚Äôarchitecture du JSON d√©pend de chaque API."
  },
  {
    "objectID": "sessions/api.html#comment-conna√Ætre-les-inputs-et-outputs-des-api",
    "href": "sessions/api.html#comment-conna√Ætre-les-inputs-et-outputs-des-api",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "2.3 Comment conna√Ætre les inputs et outputs des API ?",
    "text": "2.3 Comment conna√Ætre les inputs et outputs des API ?\nIci on a pris l‚ÄôAPI BAN comme un outil magique dont on connaissait les principaux inputs (le endpoint, les param√®tres et leur formattage‚Ä¶). Mais comment faire, en pratique, pour en arriver l√† ? Tout simplement en lisant la documentation lorsqu‚Äôelle existe et en testant celle-ci via des exemples.\nLes bonnes API proposent un outil interactif qui s‚Äôappelle le swagger. C‚Äôest un site web interactif o√π sont d√©crites les principales fonctionnalit√©s de l‚ÄôAPI et o√π l‚Äôutilisateur peut tester des exemples interactivement. Ces documentations sont souvent cr√©√©es automatiquement lors de la construction d‚Äôune API et mises √† disposition par le biais d‚Äôun point d‚Äôentr√©e /docs. Elles permettent souvent d‚Äô√©diter certains param√®tres dans le navigateur, voir le JSON obtenu (ou l‚Äôerreur g√©n√©r√©e) et r√©cup√©rer la requ√™te formatt√©e qui permet d‚Äôobtenir celui-ci. Ces consoles interactives dans le navigateur permettent de r√©pliquer le t√¢tonnement qu‚Äôon peut faire par ailleurs dans des outils sp√©cialis√©s comme postman.\nConcernant l‚ÄôAPI BAN, la documentation se trouve sur https://adresse.data.gouv.fr/api-doc/adresse. Elle n‚Äôest pas interactive, malheureusement. Mais elle pr√©sente de nombreux exemples qui peuvent √™tre test√©s directement depuis le navigateur. Il suffit d‚Äôutiliser les URL propos√©es comme exemple. Ceux-ci sont pr√©sent√©s par le biais de curl (un √©quivalent de requests en ligne de commande Linux ):\ncurl \"https://api-adresse.data.gouv.fr/search/?q=8+bd+du+port&limit=15\"\nIl suffit de copier l‚ÄôURL en question (https://api-adresse.data.gouv.fr/search/?q=8+bd+du+port&limit=15), d‚Äôouvrir un nouvel onglet et v√©rifier que cela produit bien un r√©sultat. Puis de changer un param√®tre et v√©rifier √† nouveau, jusqu‚Äô√† trouver la structure qui convient. Et apr√®s, on peut passer √† Python comme le propose l‚Äôexercice suivant."
  },
  {
    "objectID": "sessions/api.html#application",
    "href": "sessions/api.html#application",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "2.4 Application",
    "text": "2.4 Application\nPour la prochaine application, nous allons utiliser l‚Äôadresse suivante :\n\nadresse = \"88 Avenue Verdier\"\n\n\n\n\n\n\n\nExercice 1 : Structurer un appel √† une API depuis Python\n\n\n\n\nTester sans aucun autre param√®tre, le retour de notre API. Transformer en DataFrame le r√©sultat.\nSe restreindre √† Montrouge avec le param√®tre ad hoc et la recherche du code insee ou code postal ad√©quat sur Google.\n(Optionnel) : Repr√©senter l‚Äôadresse trouv√©e sur une carte.\n\n\n\n\n\nCorrection question 1\nimport requests\nimport pandas as pd\n\nban_root = \"https://api-adresse.data.gouv.fr\"\nban_search_endpoint = \"search\"\napi_ban_q1 = f\"{ban_root}/{ban_search_endpoint}?q={adresse.replace(\" \", \"+\")}\"\noutput_api_ban = requests.get(api_ban_q1).json().get('features')\n\ndf_avenue_verdier = pd.DataFrame(\n    [out['properties'] for out in output_api_ban]\n)\n\n\nLes deux premi√®res lignes du dataframe obtenu √† la question 1 devraient √™tre\n\n\n\n\n\n\n\n\n\nlabel\nscore\nhousenumber\nid\nbanId\nname\npostcode\ncitycode\nx\ny\ncity\ncontext\ntype\nimportance\nstreet\n_type\nlocality\n\n\n\n\n0\n88 Avenue Verdier 92120 Montrouge\n0.973564\n88\n92049_9625_00088\n92dd3c4a-6703-423d-bf09-fc0412fb4f89\n88 Avenue Verdier\n92120\n92049\n649270.67\n6857572.24\nMontrouge\n92, Hauts-de-Seine, √éle-de-France\nhousenumber\n0.7092\nAvenue Verdier\naddress\nNaN\n\n\n1\nAvenue Verdier 44500 La Baule-Escoublac\n0.719373\nNaN\n44055_3690\nNaN\nAvenue Verdier\n44500\n44055\n291884.83\n6701220.48\nLa Baule-Escoublac\n44, Loire-Atlantique, Pays de la Loire\nstreet\n0.6006\nAvenue Verdier\naddress\nNaN\n\n\n\n\n\n\n\nA la question 2, la requ√™te ne renvoie cette fois qu‚Äôune seule observation, qu‚Äôon pourrait retravailler avec GeoPandas pour v√©rifier qu‚Äôon a bien plac√© ce point sur une carte\n\n\nCorrection question 2\nimport pandas as pd\nimport geopandas as gpd\n\napi_ban_q2 = f\"{ban_root}/{ban_search_endpoint}?q={adresse.replace(\" \", \"+\")}&postcode=92120\"\noutput_q2 = requests.get(api_ban_q2).json()\n\noutput_q2 = pd.DataFrame(\n    [output_q2.get(\"features\")[0]['properties']]\n)\noutput_q2 = gpd.GeoDataFrame(\n    output_q2,\n    geometry=gpd.points_from_xy(output_q2.x, output_q2.y), crs=\"EPSG:2154\"\n).to_crs(4326)\noutput_q2\n\n\n\n\n\n\n\n\n\nlabel\nscore\nhousenumber\nid\nbanId\nname\npostcode\ncitycode\nx\ny\ncity\ncontext\ntype\nimportance\nstreet\ngeometry\n\n\n\n\n0\n88 Avenue Verdier 92120 Montrouge\n0.973564\n88\n92049_9625_00088\n92dd3c4a-6703-423d-bf09-fc0412fb4f89\n88 Avenue Verdier\n92120\n92049\n649270.67\n6857572.24\nMontrouge\n92, Hauts-de-Seine, √éle-de-France\nhousenumber\n0.7092\nAvenue Verdier\nPOINT (2.30914 48.81622)\n\n\n\n\n\n\n\nEnfin, √† la question 3, on obtient cette carte (plus ou moins la m√™me que pr√©c√©demment) :\n\n\nCorrection question 3\nimport folium\n\n# Extraire la longitude et la latitude\nlongitude = output_q2.geometry.x.iloc[0]\nlatitude = output_q2.geometry.y.iloc[0]\n\n# Cr√©er une carte Folium centr√©e sur le point\nm = folium.Map(location=[latitude, longitude], zoom_start=16)\n\n# D√©finir le contenu de la popup\npopup_content = f\"\"\"\n&lt;b&gt;{output_q2['name'].iloc[0]}&lt;/b&gt; has been found!\n\"\"\"\n\n# Ajouter le marqueur\nfolium.Marker(\n    location=[latitude, longitude],\n    popup=folium.Popup(popup_content, max_width=300),\n    icon=folium.Icon(color='blue', icon='info-sign')\n).add_to(m)\n\n# Afficher la carte dans le notebook (si utilis√© dans un Jupyter Notebook)\nm\n\n\nMake this Notebook Trusted to load map: File -&gt; Trust Notebook\n\n\n\n\n\n\n\n\nQuelques exemples d‚ÄôAPI √† conna√Ætre\n\n\n\n\n\nLes principaux fournisseurs de donn√©es officielles proposent des API. C‚Äôest le cas notamment de l‚ÄôInsee, d‚ÄôEurostat, de la BCE, de la FED, de la Banque Mondiale‚Ä¶\nN√©anmoins, la production de donn√©es par les institutions publiques est loin d‚Äô√™tre restreinte aux producteurs de statistiques publiques. Le portail API gouv est le point de r√©f√©rencement principal pour les API produites par l‚Äôadministration centrale fran√ßaise ou des administrations territoriales. De nombreuses villes publient √©galement des donn√©es sur leurs infrastructures par le biais d‚ÄôAPI, par exemple la ville de Paris.\nLes producteurs de donn√©es priv√©es proposent √©galement des API. Par exemple, la SNCF ou la RATP proposent des API pour certains usages. Les grands acteurs du num√©rique, par exemple Spotify  proposent g√©n√©ralement des API pour int√©grer certains de leurs services √† des applications externes.\nCependant, il faut √™tre conscient des limites de certaines API. En premier lieu, les donn√©es partag√©es ne sont pas forc√©ment tr√®s riches pour ne pas compromettre la confidentialit√© des informations partag√©es par les utilisateurs du service ou la part de march√© du producteur qui n‚Äôa pas int√©r√™t √† vous partager ses donn√©es √† forte valeur. Il faut √©galement √™tre conscient du fait qu‚Äôune API peut dispara√Ætre ou changer de structure du jour au lendemain. Les codes de restructuration de donn√©es √©tant assez adh√©rents √† une structure d‚ÄôAPI, on peut se retrouver √† devoir changer un volume cons√©quent de code si une API critique change substantiellement."
  },
  {
    "objectID": "sessions/api.html#source-principale",
    "href": "sessions/api.html#source-principale",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "3.1 Source principale",
    "text": "3.1 Source principale\nNous allons utiliser comme base principale pour ce tutoriel la base permanente des √©quipements, un r√©pertoire d‚Äô√©quipements publics accueillant du public.\nOn va commencer par r√©cup√©rer les donn√©es qui nous int√©ressent. On ne r√©cup√®re pas toutes les variables du fichier mais seulement celles qu‚Äôils nous int√©ressent : quelques variables sur l‚Äô√©quipement, son adresse et sa commune d‚Äôappartenance.\nNous allons nous restreindre aux √©tablissements d‚Äôenseignement primaire, secondaire et sup√©rieur du d√©partement de la Haute-Garonne (le d√©partement 31). Ces √©tablissements sont identifi√©s par un code particulier, entre C1 et C5.\n\nimport duckdb\n\nquery = \"\"\"\nFROM read_parquet('https://minio.lab.sspcloud.fr/lgaliana/diffusion/BPE23.parquet')\nSELECT NOMRS, NUMVOIE, INDREP, TYPVOIE, LIBVOIE,\n       CADR, CODPOS, DEPCOM, DEP, TYPEQU,\n       concat_ws(' ', NUMVOIE, INDREP, TYPVOIE, LIBVOIE) AS adresse, SIRET\nWHERE DEP = '31'\n      AND starts_with(TYPEQU, 'C')\n      AND NOT (starts_with(TYPEQU, 'C6') OR starts_with(TYPEQU, 'C7'))\n\"\"\"\n\nbpe = duckdb.sql(query)\nbpe = bpe.to_df()\n\nbpe.head(2)\n\n\n\n\n\n\n\n\n\n\n\nNOMRS\nNUMVOIE\nINDREP\nTYPVOIE\nLIBVOIE\nCADR\nCODPOS\nDEPCOM\nDEP\nTYPEQU\nadresse\nSIRET\n\n\n\n\n0\nECOLE PRIMAIRE PUBLIQUE DENIS LATAPIE\n\n\nLD\nLA BOURDETTE\n\n31230\n31001\n31\nC108\nLD LA BOURDETTE\n21310001900024\n\n\n1\nECOLE MATERNELLE PUBLIQUE\n21\n\nCHE\nDE L AUTAN\n\n31280\n31003\n31\nC107\n21 CHE DE L AUTAN\n21310003500038"
  },
  {
    "objectID": "sessions/api.html#r√©cup√©rer-des-donn√©es-√†-fa√ßon-gr√¢ce-aux-api",
    "href": "sessions/api.html#r√©cup√©rer-des-donn√©es-√†-fa√ßon-gr√¢ce-aux-api",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "3.2 R√©cup√©rer des donn√©es √† fa√ßon gr√¢ce aux API",
    "text": "3.2 R√©cup√©rer des donn√©es √† fa√ßon gr√¢ce aux API\nNous avons vu pr√©c√©demment le principe g√©n√©ral d‚Äôune requ√™te d‚ÄôAPI. Pour illustrer, de mani√®re plus massive, la r√©cup√©ration de donn√©es par le biais d‚Äôune API, essayons de r√©cup√©rer des donn√©es compl√©mentaires √† notre source principale. Nous allons utiliser l‚Äôannuaire de l‚Äô√©ducation qui fournit de nombreuses informations sur les √©tablissements scolaires. Nous utiliserons le SIRET pour croiser les deux sources de donn√©es.\nL‚Äôexercice suivant viendra illustrer l‚Äôint√©r√™t d‚Äôutiliser une API pour avoir des donn√©es √† fa√ßon et la simplicit√© √† r√©cup√©rer celles-ci via Python. N√©anmoins, cet exercice illustrera √©galement une des limites de certaines API, √† savoir la volum√©trie des donn√©es √† r√©cup√©rer.\n\n\n\n\n\n\nExercice 2\n\n\n\n\nVisiter le swagger de l‚ÄôAPI de l‚ÄôAnnuaire de l‚ÄôEducation nationale sur api.gouv.fr/documentation, et plus particuli√®rement sa ‚Äúdocumentation externe‚Äù qui permet de g√©n√©rer les urls souhait√©es en prototypant interactivement les requ√™tes. Tester une premi√®re r√©cup√©ration de donn√©es en utilisant le endpoint records sans aucun param√®tre.\nPuisqu‚Äôon n‚Äôa conserv√© que les donn√©es de la Haute Garonne dans notre base principale, on d√©sire ne r√©cup√©rer que les √©tablissements de ce d√©partement par le biais de notre API. Faire une requ√™te avec le param√®tre ad hoc, sans en ajouter d‚Äôautres.\nAugmenter la limite du nombre de param√®tres, voyez-vous le probl√®me ?\nOn va tenter de r√©cup√©rer ces donn√©es par le biais de l‚ÄôAPI tabular de data.gouv. Sa documentation est ici et l‚Äôidentifiant de la ressource est b22f04bf-64a8-495d-b8bb-d84dbc4c7983 (source). Avec l‚Äôaide de la documentation, essayer de r√©cup√©rer des donn√©es par le biais de cette API en utilisant le param√®tre Code_departement__exact=031 pour ne garder que le d√©partement d‚Äôint√©r√™t.\nVoyez-vous le probl√®me et comment nous pourrions automatiser la r√©cup√©ration de donn√©es ?\n\n\n\n\n\nR√©ponse question 1\nimport requests\n\nurl_annuaire_education = \"https://data.education.gouv.fr/api/explore/v2.1/catalog/datasets/fr-en-annuaire-education/records\"\n\nschool_q1_exo2 = pd.DataFrame(\n  requests\n  .get(url_annuaire_education)\n  .json()\n  .get(\"results\")\n)\n\nschool_q1_exo2.head(2)\n\n\n\n\n\n\n\n\n\nidentifiant_de_l_etablissement\nnom_etablissement\ntype_etablissement\nstatut_public_prive\nadresse_1\nadresse_2\nadresse_3\ncode_postal\ncode_commune\nnom_commune\n...\nlibelle_nature\ncode_type_contrat_prive\npial\netablissement_mere\ntype_rattachement_etablissement_mere\ncode_circonscription\ncode_zone_animation_pedagogique\nlibelle_zone_animation_pedagogique\ncode_bassin_formation\nlibelle_bassin_formation\n\n\n\n\n0\n0040311S\nEcole primaire publique Pierre Magnan\nEcole\nPublic\n2 avenue Jean des Figues\nLES PLANTIERS\n04200 SISTERON\n04200\n04209\nSisteron\n...\nECOLE DE NIVEAU ELEMENTAIRE\n99\n0040378P\nNone\nNone\n0040032N\n004016\nPAUL ARENE\n02101\nDIGNE SISTERON\n\n\n1\n0400748W\nEcole maternelle\nEcole\nPublic\n53 avenue de la Poste\nNone\n40360 TILH\n40360\n40316\nTilh\n...\nECOLE MATERNELLE\n99\n0400032T\nNone\nNone\n0401054D\n040020\nZAP 040020 DAX\nNone\nNone\n\n\n\n\n2 rows √ó 72 columns\n\n\n\nN√©anmoins, on a deux probl√®mes : le nombre de lignes et le d√©partement d‚Äôint√©r√™t. Essayons d√©j√† avec la question 2 de changer ce dernier.\n\n\nR√©ponse question 2\nurl_31_limite10 = \"https://data.education.gouv.fr/api/explore/v2.1/catalog/datasets/fr-en-annuaire-education/records?where=code_departement%20like%20%22031%22\"\n\nschool_q2_exo2 = pd.DataFrame(\n  requests\n  .get(url_31_limite10)\n  .json()\n  .get(\"results\")\n)\nschool_q2_exo2.head()\n\n\n\n\n\n\n\n\n\nidentifiant_de_l_etablissement\nnom_etablissement\ntype_etablissement\nstatut_public_prive\nadresse_1\nadresse_2\nadresse_3\ncode_postal\ncode_commune\nnom_commune\n...\nlibelle_nature\ncode_type_contrat_prive\npial\netablissement_mere\ntype_rattachement_etablissement_mere\ncode_circonscription\ncode_zone_animation_pedagogique\nlibelle_zone_animation_pedagogique\ncode_bassin_formation\nlibelle_bassin_formation\n\n\n\n\n0\n0310174W\nEcole maternelle publique\nEcole\nPublic\nRue des Ecoles\nNone\n31230 L ISLE EN DODON\n31230\n31239\nL'Isle-en-Dodon\n...\nECOLE MATERNELLE\n99\n0310003K\nNone\nNone\n0311108L\nNone\nNone\n16106\nCOMMINGES\n\n\n1\n0310177Z\nEcole maternelle publique Pierre Fons\nEcole\nPublic\n44 rue Notre Dame\nNone\n31600 MURET\n31600\n31395\nMuret\n...\nECOLE MATERNELLE\n99\n0311319R\nNone\nNone\n0311339M\nNone\nNone\n16107\nMURET\n\n\n2\n0310179B\nEcole maternelle publique Jean Jaur√®s\nEcole\nPublic\nAll√©es des Tilleuls\nNone\n31120 PORTET SUR GARONNE\n31120\n31433\nPortet-sur-Garonne\n...\nECOLE MATERNELLE\n99\n0311093V\nNone\nNone\n0311105H\nNone\nNone\n16108\nTOULOUSE SUD-OUEST\n\n\n3\n0310180C\nEcole maternelle publique Jacques Pr√©vert\nEcole\nPublic\n11 rue D√©sir√©\nNone\n31120 PORTET SUR GARONNE\n31120\n31433\nPortet-sur-Garonne\n...\nECOLE MATERNELLE\n99\n0311093V\nNone\nNone\n0311105H\nNone\nNone\n16108\nTOULOUSE SUD-OUEST\n\n\n4\n0310183F\nEcole maternelle publique le pilat\nEcole\nPublic\n1 rue du Dr Ferrand\nNone\n31800 ST GAUDENS\n31800\n31483\nSaint-Gaudens\n...\nECOLE MATERNELLE\n99\n0310083X\nNone\nNone\n0311108L\nNone\nNone\n16106\nCOMMINGES\n\n\n\n\n5 rows √ó 72 columns\n\n\n\nC‚Äôest mieux, mais nous avons toujours seulement 10 observations. Si on essaie d‚Äôajuster le nombre de lignes (question 3), on obtient le retour suivant de l‚ÄôAPI :\n\n\nQuestion 3\nurl_31_limite200 = \"https://data.education.gouv.fr/api/explore/v2.1/catalog/datasets/fr-en-annuaire-education/records?where=code_departement%20like%20%22031%22&limit=200\"\n\nrequests.get(url_31_limite200).json()\n\n\n{'error_code': 'InvalidRESTParameterError',\n 'message': 'Invalid value for limit API parameter: 200 was found but -1 &lt;= limit &lt;= 100 is expected.'}\n\n\nEssayons avec des donn√©es plus exhaustives : le fichier brut sur data.gouv. Comme on peut le voir dans les m√©tadonn√©es, on sait qu‚Äôon a plus de 1000 √©coles dont on peut r√©cup√©rer des donn√©es, mais qu‚Äôon en a ici extrait seulement 20. Le champ next nous donne directement l‚ÄôURL √† utiliser pour r√©cup√©rer les 20 pages suivantes : c‚Äôest gr√¢ce √† lui qu‚Äôon a une chance de r√©cup√©rer toutes nos donn√©es d‚Äôint√©r√™t.\n\n\nR√©ponse question 4\nurl_api_datagouv = \"https://tabular-api.data.gouv.fr/api/resources/b22f04bf-64a8-495d-b8bb-d84dbc4c7983/data/?Code_departement__exact=031\"\n\ncall_api_datagouv = requests.get(url_api_datagouv).json()\n\n\nLe probl√®me de la r√©cup√©ration de donn√©es via l‚ÄôAPI vient du fait que nous ne r√©cup√©rons qu‚Äôun petit √©chantillon √† chaque requ√™te. Pour y rem√©dier, nous allons devoir faire plusieurs appels successifs. Dans le JSON obtenu ci-dessus, la partie int√©ressante pour automatiser la r√©cup√©ration de nos donn√©es est la cl√© links. En bouclant sur celui-ci pour parcourir la liste des URL accessibles, on peut r√©cup√©rer des donn√©es.\n\n\nR√©ponse question 5\nimport requests\nimport pandas as pd\n\n# Initialize the initial API URL\nurl_api_datagouv = \"https://tabular-api.data.gouv.fr/api/resources/b22f04bf-64a8-495d-b8bb-d84dbc4c7983/data/?Code_departement__exact=031&page_size=50\"\n\n# Initialize an empty list to store all data entries\nall_data = []\n\n# Initialize the URL for pagination\ncurrent_url = url_api_datagouv\n\n# Loop until there is no next page\nwhile current_url:\n    try:\n        # Make a GET request to the current URL\n        response = requests.get(current_url)\n        response.raise_for_status()  # Raise an exception for HTTP errors\n\n        # Parse the JSON response\n        json_response = response.json()\n\n        # Extract data and append to the all_data list\n        page_data = json_response.get('data', [])\n        all_data.extend(page_data)\n        print(f\"Fetched {len(page_data)} records from {current_url}\")\n\n        # Get the next page URL\n        links = json_response.get('links', {})\n        current_url = links.get('next')  # This will be None if there's no next page\n\n    except requests.exceptions.RequestException as e:\n        print(f\"An error occurred: {e}\")\n        break\n\n\n\nschools_dep31 = pd.DataFrame(all_data)\nschools_dep31.head()\n\n\n\n\n\n\n\n\n__id\nIdentifiant_de_l_etablissement\nNom_etablissement\nType_etablissement\nStatut_public_prive\nAdresse_1\nAdresse_2\nAdresse_3\nCode_postal\nCode_commune\n...\nlibelle_nature\nCode_type_contrat_prive\nPIAL\netablissement_mere\ntype_rattachement_etablissement_mere\ncode_circonscription\ncode_zone_animation_pedagogique\nlibelle_zone_animation_pedagogique\ncode_bassin_formation\nlibelle_bassin_formation\n\n\n\n\n0\n48\n0312140H\nColl√®ge Ren√© Cassin\nColl√®ge\nPublic\nAvenue des Carabenes\nNone\nNone\n31650\n31506\n...\nCOLLEGE\n99\n0311850T\nNone\nNone\nNone\nNone\nNone\n16128\nTOULOUSE EST\n\n\n1\n49\n0311266H\nColl√®ge Jean Jaur√®s\nColl√®ge\nPublic\nPlace Cl√©mence Isaure\nBP 22508\nNone\n31325\n31113\n...\nCOLLEGE\n99\n0311633G\nNone\nNone\nNone\nNone\nNone\n16128\nTOULOUSE EST\n\n\n2\n55\n0312071H\nColl√®ge Jules Verne\nColl√®ge\nPublic\n1 avenue Marcel Pagnol\nNone\nNone\n31830\n31424\n...\nCOLLEGE\n99\n0312071H\nNone\nNone\nNone\nNone\nNone\n16108\nTOULOUSE SUD-OUEST\n\n\n3\n61\n0311632F\nColl√®ge Les Violettes de Aucamville\nColl√®ge\nPublic\n3 avenue des Pins\nNone\nNone\n31140\n31022\n...\nCOLLEGE\n99\n0312139G\nNone\nNone\nNone\nNone\nNone\n16110\nTOULOUSE NORD\n\n\n4\n62\n0311332E\nColl√®ge Anatole France\nColl√®ge\nPublic\n4 avenue de Lespinet\nNone\nNone\n31400\n31555\n...\nCOLLEGE\n99\n0310085Z\nNone\nNone\nNone\nNone\nNone\n16109\nTOULOUSE CENTRE\n\n\n\n\n5 rows √ó 73 columns\n\n\n\nOn peut fusionner ces nouvelles donn√©es avec nos donn√©es pr√©c√©dentes pour enrichir celles-ci. Pour faire une production fiable, il faudrait faire attention aux √©coles qui ne s‚Äôapparient pas, mais ce n‚Äôest pas grave pour cette s√©rie d‚Äôexercices.\n\nbpe_enriched = bpe.merge(\n  schools_dep31,\n  left_on = \"SIRET\",\n  right_on = \"SIREN_SIRET\"\n)\nbpe_enriched.head(2)\n\n\n\n\n\n\n\n\nNOMRS\nNUMVOIE\nINDREP\nTYPVOIE\nLIBVOIE\nCADR\nCODPOS\nDEPCOM\nDEP\nTYPEQU\n...\nlibelle_nature\nCode_type_contrat_prive\nPIAL\netablissement_mere\ntype_rattachement_etablissement_mere\ncode_circonscription\ncode_zone_animation_pedagogique\nlibelle_zone_animation_pedagogique\ncode_bassin_formation\nlibelle_bassin_formation\n\n\n\n\n0\nECOLE PRIMAIRE PUBLIQUE DENIS LATAPIE\n\n\nLD\nLA BOURDETTE\n\n31230\n31001\n31\nC108\n...\nECOLE DE NIVEAU ELEMENTAIRE\n99\n0310003K\nNone\nNone\n0311108L\nNone\nNone\n16106\nCOMMINGES\n\n\n1\nECOLE MATERNELLE PUBLIQUE\n21\n\nCHE\nDE L AUTAN\n\n31280\n31003\n31\nC107\n...\nECOLE MATERNELLE\n99\n0311335H\nNone\nNone\n0311102E\nNone\nNone\n16128\nTOULOUSE EST\n\n\n\n\n2 rows √ó 85 columns\n\n\n\nCela nous donne des donn√©es enrichies de nouvelles caract√©ristiques sur les √©tablissements. Il y a des coordonn√©es g√©ographiques dans celles-ci, mais nous allons faire comme s‚Äôil n‚Äôy en avait pas pour r√©utiliser notre API de g√©olocalisation et ainsi avoir un alibi pour utiliser les requ√™tes POST."
  },
  {
    "objectID": "sessions/api.html#logique",
    "href": "sessions/api.html#logique",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "4.1 Logique",
    "text": "4.1 Logique\nNous avons jusqu‚Äô√† pr√©sent √©voqu√© les requ√™tes GET. Nous allons maintenant pr√©senter les requ√™tes POST qui permettent d‚Äôinteragir de mani√®re plus complexe avec des serveurs de l‚ÄôAPI.\nPour d√©couvrir celles-ci, nous allons reprendre l‚ÄôAPI de g√©olocalisation pr√©c√©dente mais utiliser un autre point d‚Äôentr√©e qui n√©cessite une requ√™te POST.\nCes derni√®res sont g√©n√©ralement utilis√©es quand il est n√©cessaire d‚Äôenvoyer des donn√©es particuli√®res pour d√©clencher une action. Par exemple, dans le monde du web, si vous avez une authentification √† mettre en oeuvre, une requ√™te POST permettra d‚Äôenvoyer un token au serveur qui r√©pondra en acceptant votre authentification.\nDans notre cas, nous allons envoyer des donn√©es au serveur, ce dernier va les recevoir, les utiliser pour la g√©olocalisation puis nous envoyer une r√©ponse. Pour continuer sur la m√©taphore culinaire, c‚Äôest comme si vous donniez vous-m√™mes √† la cuisine un tupperware pour r√©cup√©rer votre plat √† emporter."
  },
  {
    "objectID": "sessions/api.html#principe",
    "href": "sessions/api.html#principe",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "4.2 Principe",
    "text": "4.2 Principe\nPrenons cette requ√™te propos√©e sur le site de documentation de l‚ÄôAPI de g√©olocalisation :\ncurl -X POST -F data=@path/to/file.csv -F columns=voie -F columns=ville -F citycode=ma_colonne_code_insee https://api-adresse.data.gouv.fr/search/csv/\nIci l‚Äôobjectif est d‚Äôobtenir des g√©olocalisations pour les adresses textuelles pr√©sentes dans un fichier .csv.\nComme nous avons pu l‚Äô√©voquer pr√©c√©demment, curl est un outil en ligne de commande qui permet de faire des requ√™tes API. L‚Äôoption -X POST indique, de mani√®re assez transparente, qu‚Äôon d√©sire faire une requ√™te POST.\nLes autres arguments sont pass√©s par le biais des options -F. En l‚Äôoccurrence, on envoie un fichier et on ajoute des param√®tres pour aider le serveur √† aller chercher la donn√©e dedans. L‚Äô@ indique que file.csv doit √™tre lu sur le disque et envoy√© dans le corps de la requ√™te comme une donn√©e de formulaire."
  },
  {
    "objectID": "sessions/api.html#application-avec-python",
    "href": "sessions/api.html#application-avec-python",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "4.3 Application avec Python",
    "text": "4.3 Application avec Python\nNous avions requests.get, il est donc logique que nous ayons requests.post. Cette fois, il faudra passer des param√®tres √† notre requ√™te sous la forme d‚Äôun dictionnaire dont les cl√©s sont le nom de l‚Äôargument et les valeurs sont des objets Python.\nLe principal d√©fi, illustr√© dans le prochain exercice, est le passage de l‚Äôargument data : il faudra renvoyer le fichier comme un objet Python par le biais de la fonction open.\n\n\n\n\n\n\nExercice 3 : une requ√™te POST pour g√©olocaliser en masse nos donn√©es\n\n\n\n\nEnregistrer au format CSV les colonnes adresse, DEPCOM et Nom_commune de la base d‚Äô√©quipements fusionn√©e avec notre r√©pertoire pr√©c√©dent (objet bpe_enriched). Il peut √™tre utile, avant l‚Äô√©criture au format CSV, de remplacer les virgules dans la colonne adresse par des espaces.\nCr√©er l‚Äôobjet response avec requests.post et les bons arguments pour g√©ocoder votre CSV.\nTransformer votre output en objet Pandas avec la commande suivante :\n\nbpe_loc = pd.read_csv(io.StringIO(response.text))\n\n\n\n\nR√©ponse question 1\nimport pathlib\noutput_path = pathlib.Path(\"data/output\")\noutput_path.mkdir(parents=True, exist_ok=True)\ncsv_file = output_path / \"bpe_before_geoloc.csv\"\n\nbpe_enriched[\"adresse\"] = bpe_enriched[\"adresse\"].str.replace(\",\", \"\")\n\nbpe_enriched.loc[:, [\"adresse\", \"DEPCOM\", \"Nom_commune\"]].to_csv(csv_file)\n\n\n\n\nR√©ponse question 2 et 3\nimport io\n\nparams = {\n    \"columns\": [\"adresse\", \"Nom_commune\"],\n    \"citycode\": \"DEPCOM\",\n    \"result_columns\": [\"result_score\", \"latitude\", \"longitude\"],\n}\n\nresponse = requests.post(\n        \"https://api-adresse.data.gouv.fr/search/csv/\",\n        data=params,\n        files={\"data\": open(csv_file, \"rb\")},\n    )\n\n\nbpe_loc = pd.read_csv(io.StringIO(response.text))\nbpe_loc = bpe_loc.rename({\"Unnamed: 0\": \"index\"}, axis = \"columns\")\n\n\nLes g√©olocalisations obtenues prennent cette forme\n\n\n\n\n\n\n\n\n\nindex\nadresse\nDEPCOM\nNom_commune\nresult_score\nlatitude\nlongitude\n\n\n\n\n0\n0\nLD LA BOURDETTE\n31001\nAgassac\n0.404609\n43.374288\n0.880679\n\n\n1\n1\n21 CHE DE L AUTAN\n31003\nAigrefeuille\n0.730293\n43.567530\n1.585745\n\n\n\n\n\n\n\nOn peut ensuite faire la jointure √† nos donn√©es initiales :\n\n\nJointure aux donn√©es initiales\nbpe_loc = bpe_loc.loc[:, [\"index\", \"result_score\", \"latitude\", \"longitude\"]]\nbpe_enriched_geocoded = (\n  bpe_enriched\n  .reset_index()\n  .merge(bpe_loc, on = \"index\", suffixes = [\"_annuaire\", \"_ban\"])\n  .drop(\"index\", axis = \"columns\")\n)\n\nbpe_enriched_geocoded.head(2)\n\n\n\n\n\n\n\n\n\nNOMRS\nNUMVOIE\nINDREP\nTYPVOIE\nLIBVOIE\nCADR\nCODPOS\nDEPCOM\nDEP\nTYPEQU\n...\netablissement_mere\ntype_rattachement_etablissement_mere\ncode_circonscription\ncode_zone_animation_pedagogique\nlibelle_zone_animation_pedagogique\ncode_bassin_formation\nlibelle_bassin_formation\nresult_score\nlatitude_ban\nlongitude_ban\n\n\n\n\n0\nECOLE PRIMAIRE PUBLIQUE DENIS LATAPIE\n\n\nLD\nLA BOURDETTE\n\n31230\n31001\n31\nC108\n...\nNone\nNone\n0311108L\nNone\nNone\n16106\nCOMMINGES\n0.404609\n43.374288\n0.880679\n\n\n1\nECOLE MATERNELLE PUBLIQUE\n21\n\nCHE\nDE L AUTAN\n\n31280\n31003\n31\nC107\n...\nNone\nNone\n0311102E\nNone\nNone\n16128\nTOULOUSE EST\n0.730293\n43.567530\n1.585745\n\n\n\n\n2 rows √ó 88 columns\n\n\n\n\n\nJointure aux donn√©es initiales\nbpe_enriched_geocoded = (\n    bpe_enriched_geocoded\n    .dropna(subset=[\"longitude_ban\",\"latitude_ban\"])\n)\n\nbpe_enriched_geocoded = gpd.GeoDataFrame(\n    bpe_enriched_geocoded,\n    geometry=gpd.points_from_xy(\n      bpe_enriched_geocoded['longitude_ban'],\n      bpe_enriched_geocoded['latitude_ban']\n      ),\n    crs=\"EPSG:4326\"\n)\n\n\nPour profiter de nos donn√©es enrichies, on peut faire une carte. Pour ajouter un peu de contexte √† celle-ci, on peut mettre un fond de carte des communes en arri√®re plan. Celui-ci peut √™tre r√©cup√©r√© avec cartiflette :\n\n\nR√©cup√©ration du fond de carte (GEOJSON)\nfrom cartiflette import carti_download\nshp_communes = carti_download(\n  crs = 4326,\n  values = [\"31\"],\n  borders=\"COMMUNE\",\n  vectorfile_format=\"topojson\",\n  filter_by=\"DEPARTEMENT\",\n  source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n  year=2022\n)\nshp_communes.crs = 4326\n\n\n\n\nCode pour la carte interactive\nimport folium\nfrom folium.plugins import MarkerCluster\nimport geopandas as gpd\n\ndepartment_border = shp_communes.dissolve(by=\"INSEE_DEP\")\ncity_borders = shp_communes.copy()\n\nlongitude = bpe_enriched_geocoded.geometry.x.iloc[0]\nlatitude = bpe_enriched_geocoded.geometry.y.iloc[0]\nm = folium.Map(location=[latitude, longitude], zoom_start=10)\n\n# Add department border (black, bold)\nfolium.GeoJson(\n    data=department_border,\n    style_function=lambda x: {\n        \"fill\": False,\n        \"color\": \"black\",\n        \"weight\": 3  # Bold border\n    }\n).add_to(m)\n\n# Add city borders (blue, thin)\nfolium.GeoJson(\n    data=city_borders,\n    style_function=lambda x: {\n        \"fill\": False,\n        \"color\": \"blue\",\n        \"weight\": 1  # Thin border\n    }\n).add_to(m)\n\n# Initialize the MarkerCluster\nmarker_cluster = MarkerCluster().add_to(m)\n\ndef generate_popup(row):\n    # Initialiser le contenu avec le nom de l'√©cole\n    popup_content = f\"&lt;b&gt;Nom:&lt;/b&gt; {row['NOMRS']}&lt;br&gt;\"\n\n    # Ajouter \"Ecole √©l√©mentaire\" avec une ic√¥ne ‚úÖÔ∏è ou ‚ùåÔ∏è selon la valeur\n    ecole_element_status = \"‚úÖÔ∏è\" if row.get('Ecole_elementaire', False) else \"‚ùåÔ∏è\"\n    popup_content += f\"&lt;b&gt;Ecole √©l√©mentaire:&lt;/b&gt; {ecole_element_status}&lt;br&gt;\"\n\n    # Ajouter \"Nombre d'√©l√®ves\" si disponible\n    if not pd.isnull(row.get('Nombre_d_eleves')):\n        popup_content += f\"&lt;b&gt;Nombre d'√©l√®ves :&lt;/b&gt; {row['Nombre_d_eleves']}&lt;br&gt;\"\n\n    # Ajouter \"Voie g√©n√©rale\" si disponible\n    if not pd.isnull(row.get('Voie_generale')):\n        popup_content += f\"&lt;b&gt;Voie g√©n√©rale :&lt;/b&gt; {row['Voie_generale']}&lt;br&gt;\"\n\n    # Ajouter \"Voie technologique\" si disponible\n    if not pd.isnull(row.get('Voie_technologique')):\n        popup_content += f\"&lt;b&gt;Voie technologique :&lt;/b&gt; {row['Voie_technologique']}&lt;br&gt;\"\n\n    return popup_content\n\n\n# Add GeoDataFrame points to the MarkerCluster\nfor _, row in bpe_enriched_geocoded.iterrows():\n    # Create the popup content\n    popup_content = generate_popup(row)\n\n    popup = folium.Popup(popup_content, max_width=300)\n\n    # Add the marker to the cluster\n    folium.Marker(\n        location=[row.geometry.y, row.geometry.x],  # Extract latitude and longitude\n        popup=popup,\n        icon=folium.Icon(color=\"blue\", icon=\"info-sign\")\n    ).add_to(marker_cluster)\n\n# Display the map inline (optional for Jupyter Notebooks)\nm\n\n\nMake this Notebook Trusted to load map: File -&gt; Trust Notebook"
  },
  {
    "objectID": "sessions/api.html#bonnes-pratiques-pour-utiliser-un-token-dans-un-code-sans-le-r√©v√©ler",
    "href": "sessions/api.html#bonnes-pratiques-pour-utiliser-un-token-dans-un-code-sans-le-r√©v√©ler",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "5.1 Bonnes pratiques pour utiliser un token dans un code sans le r√©v√©ler üëÆ",
    "text": "5.1 Bonnes pratiques pour utiliser un token dans un code sans le r√©v√©ler üëÆ\nLes tokens sont des informations personnelles qui ne doivent pas √™tre partag√©es. Ils n‚Äôont donc pas vocation √† appara√Ætre dans le code.\nComme ceci est √©voqu√© √† plusieurs reprises dans le cours de mise en production en 3e ann√©e de l‚ÄôENSAE, il est important de s√©parer le code des √©l√©ments de configuration :\n\nL‚Äôid√©e est de trouver une recette pour apporter les √©l√©ments de configuration avec le code mais sans mettre ceux-ci en clair dans le code. L‚Äôid√©e g√©n√©rale sera de stocker la valeur du token dans une variable mais ne jamais r√©v√©ler celle-ci dans le code. Comment faire d√®s lors pour d√©clarer la valeur du jeton sans que celui-ci soit apparent dans le code ?\n\nPour un code amen√© √† fonctionner de mani√®re interactive (par exemple par le biais d‚Äôun notebook), il est possible de cr√©er une boite de dialogue qui injectera la valeur renseign√©e dans une variable. Cela se fait par le biais du package getpass.\nPour le code qui tourne en non interactif, par exemple par le biais de la ligne de commande, l‚Äôapproche par variable d‚Äôenvironnement est la plus fiable, √† condition de faire attention √† ne pas mettre le fichier de mot de passe dans Git . Pour cela, le plus simple est d‚Äôutiliser dotenv si vous faites tourner votre code ou des secrets si votre code tourne par le biais de l‚Äôint√©gration continue2.\n\n\n\n\n\n\n\nImportant\n\n\n\n\n\nIl ne faut jamais mettre de token dans Git. Sinon, vous courrez le risque d‚Äôavoir votre identit√© usurp√©e : des robots scannent en continu Github √† la recherche de jetons pour ensuite lancer des d√©nis de service en se faisant passer pour vous.\nSi vous avez partag√© par erreur un jeton : pas de panique, cela peut arriver ! L‚Äôavantage des jetons est qu‚Äôils sont r√©vocables : vous pouvez l‚Äôinvalider et en cr√©er un nouveau pour continuer √† utiliser le service d√©sir√©. La bonne r√©action consiste √† r√©voquer le jeton le plus vite possible, une fois la fuite constat√©e. La meilleure parade pour √©viter ce type de fuite est d‚Äôajouter tout de suite le .env au .gitignore.\n\n\n\nL‚Äôexercice 5 permettra de mettre en oeuvre ces deux m√©thodes. Ces m√©thodes nous serviront √† ajouter de mani√®re confidentielle un payload √† des requ√™tes d‚Äôauthentification, c‚Äôest-√†-dire des informations confidentielles identifiantes en compl√©ment d‚Äôune requ√™te."
  },
  {
    "objectID": "sessions/api.html#le-portail-des-api-de-linsee",
    "href": "sessions/api.html#le-portail-des-api-de-linsee",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "5.2 Le portail des API de l‚ÄôInsee",
    "text": "5.2 Le portail des API de l‚ÄôInsee\nPour illustrer l‚Äôutilisation des API authentifi√©es, nous proposons d‚Äôexplorer le portail des API de l‚ÄôInsee.\nNous allons nous concentrer sur l‚ÄôAPI Sirene mais, sur ce portail, il en existe d‚Äôautres, notamment l‚ÄôAPI Melodi consacr√©e √† la r√©cup√©ration d‚Äôun certain nombre de sources open data de l‚ÄôInsee. L‚ÄôAPI Sirene est une version interrogeable des donn√©es Sirene open data.\n\n\n\n\n\n\nExercice 4 : API authentifi√©e par le biais du navigateur\n\n\n\n\nSe cr√©er un compte sur le portail des API\nAller voir l‚Äôespace Mes applications et en cr√©er une nouvelle. Par simplicit√©, vous pouvez la nommer ‚ÄúAtelier SSPHub‚Äù.\nDans celle-ci, aller dans l‚Äôonglet ‚ÄúClefs et jetons‚Äù.Cr√©er un jeton (vous pouvez laisser la dur√©e de validit√© propos√©e).\nCliquer sur l‚Äôonglet Souscriptions. Choisir l‚ÄôAPI Sirene.\nA droite, s√©lectionner l‚Äôapplication cr√©√©e pr√©c√©demment. Si vous allez voir votre application, elle devrait maintenant pouvoir interagir avec l‚ÄôAPI Sirene.\n\nTestons maintenant l‚ÄôAPI Sirene gr√¢ce au swagger (onglet Console de l'API) :\n\nPlus bas, dans la documentation interactive se rendre au point d‚Äôentr√©e /siren/{siren} (m√©thode GET).\nRemplir le champ q avec le SIREN 500569405 (SIREN de D√©cathlon üòâ)\nSi vous avez l‚Äôerreur ci-dessous, comprenez-vous pourquoi ?\n\n\nChanger l‚Äôapplication via le menu d√©roulant : maintenant que vous avez un token valide, soumettez √† nouveau la m√™me requ√™te.\n\nVous devriez maintenant avoir cette sortie :\n\nsortie_sirene_decathlon"
  },
  {
    "objectID": "sessions/api.html#r√©cup√©ration-des-donn√©es-via-python",
    "href": "sessions/api.html#r√©cup√©ration-des-donn√©es-via-python",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "5.3 R√©cup√©ration des donn√©es via Python ",
    "text": "5.3 R√©cup√©ration des donn√©es via Python \nPour la prochaine application, √† partir de la question 4, nous allons avoir besoin de cr√©er une classe sp√©ciale permettant √† requests de surcharger notre requ√™te d‚Äôun jeton d‚Äôauthentification. Comme elle n‚Äôest pas triviale √† cr√©er sans connaissance pr√©alable, la voici :\n\nclass BearerAuth(requests.auth.AuthBase):\n    def __init__(self, token):\n        self.token = token\n    def __call__(self, r):\n        r.headers[\"authorization\"] = \"Bearer \" + self.token\n        return r\n\n\n\n\n\n\n\nExercice 5 : les tokens avec Python\n\n\n\n\nCr√©er une variable token par le biais de getpass.\nUtiliser cette structure de code pour r√©cup√©rer la donn√©e voulue\n\nrequests.get(\n    url,\n    auth=BearerAuth(token)\n)\n\nRemplacer l‚Äôutilisation de getpass par l‚Äôapproche variable d‚Äôenvironnement gr√¢ce √† dotenv.\n\n\n\n\n\nCorrection de l‚Äôexercice\nimport os\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\nsiren=\"500569405\"\ntoken = os.getenv(\"TOKEN_API_INSEE\")\nif token is not None:\n    print(\"Token has been retrieved from env var\")\n\nr = requests.get(\n    f\"https://api.insee.fr/entreprises/sirene/V3.11/siren/{siren}\",\n    auth=BearerAuth(token)\n)\n\nsortie_sirene_decathlon = r.json()\nsortie_sirene_decathlon\n\n\n\n\n\n\n\n\nsortie_sirene_decathlon\n\n\n\n\n\n\nNous avons un dataframe avec de nombreux SIRET (bpe). On pourrait vouloir r√©cup√©rer des infos sur ceux-ci par le biais de l‚ÄôAPI. N√©anmoins les conditions d‚Äôusage de celle-ci sont restrictives : pas plus de 30 appels par minute.\nOn ne peut donc faire une boucle sur notre dataframe sans contr√¥ler le nombre d‚Äôappels √† la minute. Id√©alement, nous ferions de l‚Äôenvoi par bash qui permet d‚Äôenvoyer plusieurs enregistrement √† la fois dans une seule requ√™te (comme nous avons fait pour les g√©olocalisations) mais ce n‚Äôest pas possible : l‚ÄôAPI Sirene est une API pour de la consultation de donn√©es ponctuelles, pas du traitement statistique sur de gros volumes.\nL‚Äôautre approche possible, que nous allons adopter, est de mettre un temps d‚Äôattente entre chaque appel √† l‚ÄôAPI. Nous allons donc faire une boucle mais, entre chaque it√©ration, mettre un temps de repos de 2 secondes.\n\n\nFonction utile pour cet exercice\nsiret = \"21310001900024\"\n\ndef get_ape(siret: str = \"21310001900024\", token: str = \"\"):\n    info_siret = requests.get(\n        f\"https://api.insee.fr/entreprises/sirene/V3.11/siret/{siret}\",\n        auth=BearerAuth(token)\n    ).json()\n    ape = (info_siret\n        .get(\"etablissement\", {})\n        .get(\"uniteLegale\", {})\n        .get(\"activitePrincipaleUniteLegale\", {})\n    )\n    return ape\n\nget_ape(siret, token)\n\n\n\n\n\n\n\n\nExercice 6 : g√©n√©raliser des appels √† des API\n\n\n\nNous voulons r√©cup√©rer l‚Äôactivit√© pricnipal de nos √©tablissements (le code APE, qui devrait normalement √™tre 84.11Z).\nUtiliser le package time et sa fonction sleep pour marquer un temps d‚Äôarr√™t lorsqu‚Äôon it√©re sur les dix premi√®res observations de notre dataframe pour r√©cup√©rer ce code.\n\n\n\n\nCorrection de l‚Äôexercice\nimport time\n\nfirst_siret = []\n\nfor index, row in bpe.head(10).iterrows():\n    first_siret += [get_ape(row['SIRET'], token)]\n    time.sleep(2)"
  },
  {
    "objectID": "sessions/api.html#footnotes",
    "href": "sessions/api.html#footnotes",
    "title": "Atelier pour d√©couvrir la r√©cup√©ration de donn√©es via des API",
    "section": "Notes de bas de page",
    "text": "Notes de bas de page\n\n\nTechnique consistant √† singer le comportement d‚Äôun navigateur web et de r√©cup√©rer de l‚Äôinformation en moissonnant le HTML auquel acc√®de un site web‚Ü©Ô∏é\nC‚Äôest par exemple l‚Äôapproche adopt√©e pour construire ces supports. Cela se fait de cette mani√®re.‚Ü©Ô∏é"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Masterclass du SSPHub",
    "section": "",
    "text": "Site web en construction"
  },
  {
    "objectID": "index.html#replays-des-sessions",
    "href": "index.html#replays-des-sessions",
    "title": "Masterclass du SSPHub",
    "section": "Replays des sessions",
    "text": "Replays des sessions\nA venir"
  }
]